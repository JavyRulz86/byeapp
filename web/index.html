<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' https://*.googleapis.com https://*.gstatic.com;
    script-src 'self' 'unsafe-inline' https://accounts.google.com https://*.googleapis.com https://*.gstatic.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    img-src 'self' data: https://*.googleusercontent.com;
    connect-src 'self' https://*.googleapis.com;
    frame-src https://accounts.google.com;
  ">
  <base href="$FLUTTER_BASE_HREF">

  <!-- PWA Config -->
  <meta name="theme-color" content="#0175C2">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="favicon.png">
  <title>Goodbye App</title>

  <!-- Google Identity Services (Moderno) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script>
    function handleCredentialResponse(response) {
      console.log("Google ID Token recibido:", response.credential);
      
      // Prioridad 1: Flutter WebView
      if (window.flutter_inappwebview?.callHandler) {
        flutter_inappwebview.callHandler('googleSignIn', response.credential);
        return;
      }
      
      // Prioridad 2: Almacenamiento local (para web estándar)
      localStorage.setItem('google_id_token', response.credential);
      
      // Opcional: Recarga para aplicaciones SPA
      if (!window.flutterWebviewPlugin) {
        window.location.reload();
      }
    }

    function initializeGoogleSignIn() {
      try {
        google.accounts.id.initialize({
          client_id: '1003537024990-nsopm116l0j12hvdrm0rs3cmabuuuef7.apps.googleusercontent.com',
          callback: handleCredentialResponse,
          ux_mode: 'popup',
          auto_select: false
        });

        google.accounts.id.renderButton(
          document.getElementById("google-signin-button"),
          { 
            type: "standard",
            theme: "outline", 
            size: "large",
            text: "signin_with",
            shape: "rectangular"
          }
        );

        // Opcional: Muestra el One Tap UI
        // google.accounts.id.prompt();
      } catch (error) {
        console.error("Error inicializando Google Sign-In:", error);
      }
    }

    // Inicialización segura
    window.addEventListener('load', initializeGoogleSignIn);
  </script>
</head>
<body>
  <div id="google-signin-button"></div>
  <script src="flutter_bootstrap.js" defer></script>
</body>
</html>